{% extends 'base.html' %}
{% block body %}
<h1>Jury Page for {{ dance }} heat {{ heat }}</h1>
<table class="table border bordered">
<thead>
<tr>
    <th>Pair</th>
    {% for subdance in subdances %}
        <th>{{ subdance }}</th>
    {% endfor %}
</tr>
</thead>
{% for pair in pairs %}
<tr>
    <td style="border-bottom-style:hidden;">
        M{{ pair.BackNumber }}
    </td>
    {% for subdance in subdances %}
    <td style="border-bottom-style:hidden;">
        <div class="input-control text" style="width:100%!important;">
            <input id="M{{ pair.id }}_{{ subdance.id }}" type="tel" min="5" max="10" step="0.5"/>
        </div>
    </td>
    {% endfor %}
</tr>
<tr>
    <td>
        V{{ pair.BackNumber }}
    </td>
    {% for subdance in subdances %}
    <td>
        <div class="input-control text" style="width:100%!important;">
            <input id="V{{ pair.id }}_{{ subdance.id }}" type="tel" min="5" max="10" step="0.5"/>
        </div>
    </td>
    {% endfor %}
</tr>
{% endfor %}
</table>
{% endblock %}

{% block scripts %}
{{  block.super }}
<script>
$(document).ready(function(){
    if(window.location.protocol == "https:") {
        window.socket = new WebSocket("wss://" + window.location.hostname + '/afdansen/jury/socket/{{ dance.id }}/');
    }
    else
    {
        window.socket = new WebSocket("ws://" + window.location.hostname + ':' + window.location.port + '/afdansen/jury/socket/{{ dance.id }}/');
    }

    window.socket.onmessage = function(e) {
        try {
            var pckg = JSON.parse(e.data);
            //console.log(pckg);
            for (var key in pckg) {
                if (pckg.hasOwnProperty(key)) {
                    $('#' + key).val(pckg[key]);
                }
            }
            $.Notify({
                caption: 'server connection',
                content: 'Saved grades loaded from server',
                type: 'success'
            });
            return;
        }
        catch(err)
        {

        }
        if(e.data.indexOf('Invalid') == 0)
        {
            $.Notify({
                caption: 'server response',
                content: e.data,
                type: 'warning'
            })
        }
        else
        {
            $.Notify({
                caption: 'server response',
                content: e.data,
                type: 'success'
            })
        }
    };

    window.socket.onopen = function(e) {
        $.Notify({
            caption: 'Connection succesfull',
            content: 'Connection to server established',
            type: 'success'
        });
        $('input').on('change', function(e)
        {
            if(e.target.value == '')
            {
                return;
            }
            if(window.socket.readyState == 3)
            {
                $.Notify({
                    caption: 'Connection lost',
                    content: 'Connection was lost, new input not saved. Please refresh page',
                    type: 'alert'
                })
            }
            else {
                window.debug = e.target;
                var subject = e.target.id;
                var packet = {
                    'dance': {{ dance.id }},
                    'pair': Number(subject.split('_')[0].substr(1)),
                    'person': subject[0],
                    'grade': e.target.value,
                    'subdance': subject.split('_')[1]
                };
                //console.log(packet);
                window.socket.send(JSON.stringify(packet));
            }
        });

    };

    window.socket.onclose = function(e) {
        $.Notify({
            caption: 'Connection lost',
            content: 'Connection to server lost, please refresh page',
            type: 'alert'
        });
    };
});
</script>
{% endblock %}